<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–§–∏—Å–∫–∞–ª—å–Ω—ã–π —á–µ–∫: MAGNUM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Courier New', Courier, monospace; background: #eaeff2; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .controls { background: #ffffff; padding: 20px; border-radius: 15px; width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 25px; border: 1px solid #d1d8e0; }
        h3 { margin-top: 0; color: #2d3436; font-family: sans-serif; text-align: center; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #dfe6e9; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
        button { background: #d63031; color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: #ae2021; }
        .btn-alt { background: #2d3436; margin-top: 5px; }

        #receipt-wrap { background: white; padding: 20px; border-radius: 2px; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .receipt { width: 300px; padding: 20px; color: #000; position: relative; }
        .receipt::after { content: ""; position: absolute; bottom: -15px; left: 0; width: 100%; height: 15px; 
            background: linear-gradient(-135deg, white 7px, transparent 0), linear-gradient(135deg, white 7px, transparent 0); background-size: 14px 14px; }
        
        .header { text-align: center; margin-bottom: 15px; }
        .magnum-title { font-size: 24px; font-weight: 900; letter-spacing: -1px; }
        .divider { border-top: 1px dashed #000; margin: 10px 0; }
        .row { display: flex; justify-content: space-between; margin: 4px 0; font-size: 14px; }
        .total { font-size: 22px; font-weight: bold; margin-top: 10px; }
        .qr-area { text-align: center; margin: 15px 0; }
        .qr-area img { width: 160px; height: 160px; border: 1px solid #eee; padding: 5px; }
        .footer-text { font-size: 11px; text-align: center; margin-top: 10px; line-height: 1.4; }
    </style>
</head>
<body>

    <div class="controls">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ MAGNUM —á–µ–∫–∞</h3>
        <input type="text" id="shopName" value="MAGNUM CASH & CARRY" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞">
        <input type="number" id="sumValue" value="12500" placeholder="–°—É–º–º–∞">
        <select id="currency">
            <option value="‚Ç∏">–¢–µ–Ω–≥–µ (‚Ç∏)</option>
            <option value="‚ÇΩ">–†—É–±–ª—å (‚ÇΩ)</option>
            <option value="$">–î–æ–ª–ª–∞—Ä ($)</option>
        </select>
        <button onclick="download()">üì• –°–∫–∞—á–∞—Ç—å PNG</button>
        <button class="btn-alt" onclick="sendToPython()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Python</button>
    </div>

    <div id="receipt-wrap">
        <div class="receipt" id="myReceipt">
            <div class="header">
                <div class="magnum-title" id="out-shop">MAGNUM</div>
                <div style="font-size: 10px;">–ë–ò–ù: 070440001234</div>
                <div style="font-size: 10px;">–≥. –ê–ª–º–∞—Ç—ã, –ø—Ä. –ê–±–∞—è 44</div>
            </div>

            <div class="row"><span>–ß–µ–∫:</span><span>‚Ññ00001954</span></div>
            <div class="row"><span>–î–∞—Ç–∞:</span><span id="out-date">--.--.----</span></div>
            <div class="divider"></div>
            
            <div class="row"><span>–¢–æ–≤–∞—Ä—ã –≤ –∞—Å—Å–æ—Ä—Ç.</span><span id="out-subtotal">0.00</span></div>
            <div class="row" style="font-size: 11px;"><span>1.000 x <span id="out-price">0.00</span></span></div>
            <div class="divider"></div>

            <div class="row total">
                <span>–ò–¢–û–ì–û:</span>
                <span><span id="out-total">0</span> <span class="curr">‚Ç∏</span></span>
            </div>

            <div class="row"><span>–ù–î–° (12%):</span><span><span id="out-tax">0</span> <span class="curr">‚Ç∏</span></span></div>
            <div class="row"><span>–û–ø–ª–∞—Ç–∞:</span><span>–ö–∞—Ä—Ç–∞ Kaspi</span></div>

            <div class="qr-area" id="qr-code">
                </div>

            <div class="footer-text">
                <strong>–§–ò–°–ö–ê–õ–¨–ù–´–ô –ß–ï–ö</strong><br>
                –û–û–§–î: oofd.kz<br>
                –§–∏—Å–∫–∞–ª—å–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫: 881200344510<br>
                *** –°–ü–ê–°–ò–ë–û –ó–ê –ü–û–ö–£–ü–ö–£! ***
            </div>
        </div>
    </div>

    <script>
        function update() {
            const shop = document.getElementById('shopName').value;
            const sum = parseFloat(document.getElementById('sumValue').value) || 0;
            const curr = document.getElementById('currency').value;
            const now = new Date().toLocaleString('ru-RU');

            document.getElementById('out-shop').innerText = shop;
            document.getElementById('out-total').innerText = sum.toFixed(2);
            document.getElementById('out-subtotal').innerText = sum.toFixed(2);
            document.getElementById('out-price').innerText = sum.toFixed(2);
            document.getElementById('out-date').innerText = now;
            document.querySelectorAll('.curr').forEach(el => el.innerText = curr);

            // –ù–î–°
            document.getElementById('out-tax').innerText = (sum * 12 / 112).toFixed(2);

            // –†–ê–ë–û–ß–ê–Ø –°–°–´–õ–ö–ê –ù–ê –ü–†–û–í–ï–†–ö–£
            const checkUrl = `https://consumer.oofd.kz/ticket/verify?i=${sum}&t=${now.replace(/[^0-9]/g, '')}&s=881200344510`;
            const qrImgUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(checkUrl)}`;
            
            document.getElementById('qr-code').innerHTML = `
                <a href="${checkUrl}" target="_blank">
                    <img src="${qrImgUrl}" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ oofd.kz">
                </a>`;
        }

        function download() {
            html2canvas(document.getElementById('myReceipt')).then(canvas => {
                let a = document.createElement('a');
                a.download = 'magnum_check.png';
                a.href = canvas.toDataURL();
                a.click();
            });
        }

        async function sendToPython() {
            const data = {
                shop: document.getElementById('shopName').value,
                total: document.getElementById('sumValue').value,
                currency: document.getElementById('currency').value
            };
            try {
                const response = await fetch('/api/save_check', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const res = await response.json();
                alert(res.message);
            } catch (e) {
                alert("–û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä Python –Ω–µ –∑–∞–ø—É—â–µ–Ω!");
            }
        }

        document.querySelectorAll('input, select').forEach(el => el.oninput = update);
        update();
    </script>
</body>
</html>